<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Quiz | Programming Quiz App</title>
    <link rel="stylesheet" href="../css/styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Programming Quiz</h1>
            <div class="user-info">
                <span id="user-display-name">Guest</span>
                <button id="logout-btn" class="btn btn-small">Logout</button>
            </div>
        </header>

        <main>
            <!-- Quiz Information -->
            <section class="quiz-info-section">
                <div class="quiz-header">
                    <button id="back-to-modules" class="btn btn-small btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Modules
                    </button>
                    <div class="quiz-title">
                        <h2 id="quiz-language-name">Python</h2>
                        <h3 id="quiz-module-name">Python Basics</h3>
                    </div>
                </div>
                <div class="quiz-progress">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-text">
                        Question <span id="current-question-num">0</span> of <span id="total-questions">0</span>
                    </div>
                </div>
            </section>

            <!-- Loading Section -->
            <section id="loading-section" class="quiz-section">
                <div class="loading-container">
                    <div class="loading-spinner">Loading quiz questions...</div>
                </div>
            </section>

            <!-- Question Section -->
            <section id="question-section" class="quiz-section" style="display: none;">
                <div class="question-container">
                    <h3 id="question-text" class="question-text"></h3>
                    <div id="code-snippet" class="code-snippet" style="display: none;"></div>
                    <div id="options-container" class="options-container">
                        <!-- Options will be inserted here -->
                    </div>
                </div>
                <div class="question-actions">
                    <button id="next-btn" class="btn btn-primary" disabled>Next Question</button>
                </div>
            </section>

            <!-- Feedback Section (Initially Hidden) -->
            <section id="feedback-section" class="quiz-section" style="display: none;">
                <div id="feedback-container" class="feedback-container">
                    <!-- Feedback content will be inserted here -->
                </div>
            </section>

            <!-- Results Section (Initially Hidden) -->
            <section id="results-section" class="quiz-section" style="display: none;">
                <div class="results-container">
                    <h2>Quiz Completed!</h2>
                    <div class="score-display">
                        <div class="score-circle">
                            <span id="score-percentage">0%</span>
                        </div>
                        <p>Your Score: <span id="score-fraction">0/0</span></p>
                    </div>
                    <div class="results-details">
                        <p>Correct Answers: <span id="correct-answers">0</span></p>
                        <p>Incorrect Answers: <span id="incorrect-answers">0</span></p>
                        <p>Time Taken: <span id="time-taken">0 minutes, 0 seconds</span></p>
                    </div>
                    <div class="results-actions">
                        <button id="retry-quiz-btn" class="btn">Retry Quiz</button>
                        <button id="select-module-btn" class="btn btn-secondary">Select Another Module</button>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 Programming Quiz App</p>
        </footer>
    </div>

    <!-- Include Firebase configuration -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Quiz state variables
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let selectedAnswers = [];
        let startTime = null;
        let endTime = null;
        
        // Get selected language and module from session storage
        const selectedLanguageId = sessionStorage.getItem('selectedLanguageId');
        const selectedLanguageName = sessionStorage.getItem('selectedLanguageName');
        const selectedModuleId = sessionStorage.getItem('selectedModuleId');
        const selectedModuleName = sessionStorage.getItem('selectedModuleName');
        
        // Initialize quiz
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    document.getElementById('user-display-name').textContent = user.displayName || user.email || 'User';
                } else {
                    // No user is signed in, redirect to login
                    window.location.href = 'login.html';
                }
            });
            
            // Check if language and module are selected
            if (!selectedLanguageId || !selectedModuleId) {
                // Redirect to selection page if missing
                window.location.href = 'quiz-selection.html';
                return;
            }
            
            // Set quiz header information
            document.getElementById('quiz-language-name').textContent = selectedLanguageName;
            document.getElementById('quiz-module-name').textContent = selectedModuleName;
            
            // Handle logout
            document.getElementById('logout-btn').addEventListener('click', function() {
                firebase.auth().signOut().then(function() {
                    window.location.href = 'login.html';
                }).catch(function(error) {
                    console.error('Logout error:', error);
                });
            });
            
            // Handle back button
            document.getElementById('back-to-modules').addEventListener('click', function() {
                window.location.href = 'quiz-selection.html';
            });
            
            // Handle retry button
            document.getElementById('retry-quiz-btn').addEventListener('click', function() {
                resetQuiz();
            });
            
            // Handle select another module button
            document.getElementById('select-module-btn').addEventListener('click', function() {
                window.location.href = 'quiz-selection.html';
            });
            
            // Handle next button
            document.getElementById('next-btn').addEventListener('click', function() {
                // If feedback is shown, hide it and move to next question
                if (document.getElementById('feedback-section').style.display === 'block') {
                    document.getElementById('feedback-section').style.display = 'none';
                    
                    // Move to next question or show results if finished
                    currentQuestionIndex++;
                    if (currentQuestionIndex < quizQuestions.length) {
                        displayQuestion(currentQuestionIndex);
                    } else {
                        endTime = new Date();
                        showResults();
                    }
                }
            });
            
            // Start the quiz
            startQuiz();
        });
        
        // Function to start the quiz
        function startQuiz() {
            startTime = new Date();
            fetchQuizQuestions();
        }
        
        // Function to reset the quiz
        function resetQuiz() {
            currentQuestionIndex = 0;
            selectedAnswers = [];
            startTime = new Date();
            
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('question-section').style.display = 'none';
            
            // Shuffle questions
            quizQuestions = shuffleArray([...quizQuestions]);
            
            // Start from first question
            displayQuestion(0);
        }
        
        // Function to fetch quiz questions from Firestore
        function fetchQuizQuestions() {
            const questionsPath = `programming_languages/${selectedLanguageId}/modules/${selectedModuleId}/questions`;
            
            firebase.firestore().collection(questionsPath)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        showError('No questions found for this module.');
                        return;
                    }
                    
                    // Process questions
                    querySnapshot.forEach((doc) => {
                        const questionData = doc.data();
                        
                        // Validate question data structure
                        if (questionData.question && questionData.options && questionData.correctAnswer) {
                            quizQuestions.push({
                                id: doc.id,
                                question: questionData.question,
                                options: questionData.options,
                                correctAnswer: questionData.correctAnswer,
                                explanation: questionData.explanation || '',
                                codeSnippet: questionData.codeSnippet || null
                            });
                        }
                    });
                    
                    // Update total questions count
                    document.getElementById('total-questions').textContent = quizQuestions.length;
                    
                    // Shuffle questions
                    quizQuestions = shuffleArray(quizQuestions);
                    
                    if (quizQuestions.length > 0) {
                        // Start with first question
                        displayQuestion(0);
                    } else {
                        showError('No valid questions found for this module.');
                    }
                })
                .catch((error) => {
                    console.error("Error fetching questions: ", error);
                    showError(`Failed to load questions: ${error.message}`);
                });
        }
        
        // Function to display a question
        function displayQuestion(index) {
            // Hide loading, show question
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('question-section').style.display = 'block';
            
            // Update progress
            document.getElementById('current-question-num').textContent = index + 1;
            const progressPercentage = ((index + 1) / quizQuestions.length) * 100;
            document.getElementById('progress-fill').style.width = `${progressPercentage}%`;
            
            // Get current question
            const question = quizQuestions[index];
            
            // Display question text
            document.getElementById('question-text').textContent = question.question;
            
            // Display code snippet if present
            const codeSnippetElement = document.getElementById('code-snippet');
            if (question.codeSnippet) {
                codeSnippetElement.style.display = 'block';
                codeSnippetElement.innerHTML = `<pre><code>${escapeHtml(question.codeSnippet)}</code></pre>`;
            } else {
                codeSnippetElement.style.display = 'none';
            }
            
            // Display options
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, optionIndex) => {
                const optionId = `option-${optionIndex}`;
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.innerHTML = `
                    <input type="radio" name="quiz-option" id="${optionId}" value="${optionIndex}">
                    <label for="${optionId}">${option}</label>
                `;
                optionsContainer.appendChild(optionElement);
                
                // Add click event to option
                optionElement.addEventListener('click', function() {
                    // Select this option's radio button
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Enable next button
                    document.getElementById('next-btn').disabled = false;
                    
                    // Handle answer selection
                    handleAnswerSelection(optionIndex);
                });
            });
            
            // Disable next button until option selected
            document.getElementById('next-btn').disabled = true;
        }
        
        // Function to handle answer selection
        function handleAnswerSelection(selectedOptionIndex) {
            const currentQuestion = quizQuestions[currentQuestionIndex];
            const isCorrect = selectedOptionIndex === currentQuestion.correctAnswer;
            
            // Store user's answer
            selectedAnswers[currentQuestionIndex] = {
                questionId: currentQuestion.id,
                selectedOption: selectedOptionIndex,
                isCorrect: isCorrect
            };
            
            // Show feedback
            showFeedback(isCorrect, currentQuestion);
        }
        
        // Function to show feedback on answer
        function showFeedback(isCorrect, question) {
            const feedbackSection = document.getElementById('feedback-section');
            const feedbackContainer = document.getElementById('feedback-container');
            
            // Set feedback content based on correctness
            if (isCorrect) {
                feedbackContainer.innerHTML = `
                    <div class="feedback-correct">
                        <i class="fas fa-check-circle"></i>
                        <h3>Correct!</h3>
                        ${question.explanation ? `<p>${question.explanation}</p>` : ''}
                    </div>
                `;
            } else {
                const correctAnswerText = question.options[question.correctAnswer];
                feedbackContainer.innerHTML = `
                    <div class="feedback-incorrect">
                        <i class="fas fa-times-circle"></i>
                        <h3>Incorrect</h3>
                        <p>The correct answer is: ${correctAnswerText}</p>
                        ${question.explanation ? `<p>${question.explanation}</p>` : ''}
                    </div>
                `;
            }
            
            // Show feedback section
            feedbackSection.style.display = 'block';
        }
        
        // Function to show results at the end of quiz
        function showResults() {
            // Calculate results
            const totalQuestions = quizQuestions.length;
            const correctAnswers = selectedAnswers.filter(answer => answer.isCorrect).length;
            const incorrectAnswers = totalQuestions - correctAnswers;
            const scorePercentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            // Calculate time taken
            const timeDiff = endTime - startTime; // in milliseconds
            const minutes = Math.floor(timeDiff / 60000);
            const seconds = Math.floor((timeDiff % 60000) / 1000);
            
            // Update results display
            document.getElementById('score-percentage').textContent = `${scorePercentage}%`;
            document.getElementById('score-fraction').textContent = `${correctAnswers}/${totalQuestions}`;
            document.getElementById('correct-answers').textContent = correctAnswers;
            document.getElementById('incorrect-answers').textContent = incorrectAnswers;
            document.getElementById('time-taken').textContent = `${minutes} minutes, ${seconds} seconds`;
            
            // Hide question section, show results section
            document.getElementById('question-section').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';
            
            // Save results to Firestore (optional)
            saveQuizResults(correctAnswers, totalQuestions, timeDiff);
        }
        
        // Function to save quiz results to Firestore
        function saveQuizResults(correctAnswers, totalQuestions, timeTaken) {
            // Only save if user is authenticated
            const user = firebase.auth().currentUser;
            if (!user) return;
            
            const resultsData = {
                userId: user.uid,
                userName: user.displayName || user.email || 'Anonymous',
                languageId: selectedLanguageId,
                languageName: selectedLanguageName,
                moduleId: selectedModuleId,
                moduleName: selectedModuleName,
                correctAnswers: correctAnswers,
                totalQuestions: totalQuestions,
                scorePercentage: (correctAnswers / totalQuestions) * 100,
                timeTaken: timeTaken, // in milliseconds
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to results collection
            firebase.firestore().collection('quiz_results')
                .add(resultsData)
                .then(() => {
                    console.log('Results saved successfully');
                })
                .catch((error) => {
                    console.error('Error saving results:', error);
                });
        }
        
        // Function to show error message
        function showError(message) {
            document.getElementById('loading-section').innerHTML = `
                <div class="error-container">
                    <p class="error-message">${message}</p>
                    <button class="btn" onclick="window.location.href='quiz-selection.html'">
                        Return to Quiz Selection
                    </button>
                </div>
            `;
        }
        
        // Helper function to shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
    
    <!-- Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>